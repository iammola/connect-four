function puckHover(e){!previewPuck.classList.contains("placing")&&turn&&P1&&P2&&(previewPuck.classList.add("choosing"),previewPuck.style.left=`${e.getBoundingClientRect().left}px`,setPuck())}function puckPlace(e,t){if(!previewPuck.classList.contains("placing")&&turn&&P1&&P2){currentPlayer==avatar&&waitingUser(),previewPuck.classList.remove("choosing"),previewPuck.classList.add("placing");let r=e.lastElementChild;for(;r.classList.contains("filled")&&r.previousElementSibling;)r=r.previousElementSibling;const n=r.getBoundingClientRect().top;previewPuck.style.top=`${n}px`,previewPuck.addEventListener("transitionend",()=>cellPuck(r,e,t))}}function puckLeave(){!previewPuck.classList.contains("placing")&&turn&&P1&&P2&&currentPlayer.official&&(previewPuck.classList.remove("choosing"),previewPuck.removeAttribute("style"))}function puckMove(e){const{x:t,right:r}=caseColumns[0].parentElement.getBoundingClientRect();!previewPuck.classList.contains("choosing","placing")&&e.clientX>=t&&e.clientX<=r&&parseInt(getComputedStyle(previewPuck).top.slice(0,-2))==defaultPuckTop&&turn&&P1&&P2&&currentPlayer.official&&(previewPuck.style.left=`${e.clientX}px`,previewPuck.style.backgroundColor=currentPlayer.color)}function waitingUser(e=!1,t=!1,r=userMessages.opponentsTurn){if(userWait.parentElement.classList.contains("unset_waiting")&&t)userWait.parentElement.classList.remove("unset_waiting"),userWait.querySelector(".sub_title").innerText=userWait.querySelector(".room_id .code_title").innerText=userWait.querySelector(".room_id .code").innerText=userWait.querySelector(".title").innerText="";else{userWait.parentElement.classList.add("unset_waiting"),userWait.querySelector(".title").innerText=r.title,userWait.querySelector(".sub_title").innerText=r.subTitle;let t=1;e&&(userWait.querySelector(".room_id .code_title").innerText="Game Code",userWait.querySelector(".room_id .code").innerText=avatar.room),clearInterval(interval),interval=setInterval(()=>{t>4&&(t=1),userWait.querySelector(".title").innerText=r.title;for(let e=0;e<t;e++)userWait.querySelector(".title").innerText+=".";t++},1250)}}function cellPuck(e,t,r){!e.classList.contains("filled")&&turn&&(e.classList.add("filled"),e.style.backgroundColor=currentPlayer.color,currentPlayer.addSpot(cellCoordinate(e,t,r)),currentPlayer==P1?currentPlayer=P2:currentPlayer==P2&&(currentPlayer=P1),setPuck(),previewPuck.classList.remove("placing"),previewPuck.removeAttribute("style"),previewPuck.removeEventListener("transitionend",cellPuck))}function setPuck(){currentPlayer==P1?previewPuck.style.backgroundColor=P1.color:currentPlayer==P2&&(previewPuck.style.backgroundColor=P2.color)}function possibleWins(){const e={},t={},r={};for(i=1;i<=columns;i++)for(j=1;j<=rows;j++){const n=[],s=[],o=[],a=[];for(let e=0;e<minStreak;e++){let t=i+e,r=j+e;r<=rows&&s.push(`(${r}, ${i})`),t<=columns&&n.push(`(${j}, ${t})`),t<=columns&&r<=rows&&o.push(`(${r}, ${t})`),t>0&&(r-=2*e)>0&&t<=columns&&a.push(`(${r}, ${t})`)}s.length==minStreak&&(e[s.join("-")]=1),n.length==minStreak&&(t[n.join("-")]=1),o.length==minStreak&&(r[o.join("-")]=1),a.length==minStreak&&(r[a.reverse().join("-")]=1)}return{vertical:Object.keys(e),horizontal:Object.keys(t),diagonal:Object.keys(r)}}function playerPossibleWins(e){let t={},r=!1;for(const r in streaks)if(streaks.hasOwnProperty(r)){const n=streaks[r];t[r]={};for(const i in n)if(n.hasOwnProperty(i)){const s=n[i].split("-");e.forEach(e=>{const t=s.findIndex(t=>t==e);t>-1&&(s[t]=1)}),s.find(e=>!isNaN(parseInt(e)))&&(t[r][i]=s.join("-"))}}for(const e in t){if(r)break;const n=t[e];for(const e in n)if(n[e].split("-").every(e=>!isNaN(parseInt(e)))){r=!0;break}}return{playerChances:t,isWon:r}}function cellCoordinate(e,t,r){const n=`(${Array.from(t.children).findIndex(t=>t==e)+1}, ${r+1})`;return n}function events(){caseColumns.forEach((e,t)=>{e.addEventListener("mouseenter",()=>puckHover(e)),e.addEventListener("click",()=>puckPlace(e,t))}),previewColumns.forEach((e,t)=>{e.addEventListener("mouseenter",()=>puckHover(e)),e.addEventListener("click",()=>puckPlace(caseColumns[t],t))}),caseColumns[0].parentElement.addEventListener("mouseleave",()=>puckLeave()),previewColumns[0].parentElement.addEventListener("mouseleave",()=>puckLeave()),addEventListener("mousemove",e=>puckMove(e))}function resetCase(){P1.resetPlayer(),P2.resetPlayer(),caseColumns[0].parentElement.innerHTML=resetColumns.case,previewColumns[0].parentElement.innerHTML=resetColumns.preview,caseColumns=Array.from(document.querySelectorAll(".case .columns")),previewColumns=Array.from(document.querySelectorAll(".preview .cell")),events()}function showOpponentMove(e){if(turn=!turn,e.id!=avatar.id&&turn){setPuck(),waitingUser(!1,!0);const t=previewColumns[e.cell.slice(-2,-1)-1];puckHover(t),t.click()}}function playerAlert(e){if(P1&&P2){const t=document.querySelector(".player_disconnect_modal");t.parentElement.classList.remove("unset_waiting"),t.parentElement.classList.add("unset_disconnect"),t.querySelector(".player_disconnect .message .user").innerText=`Player ${e.id} (${e.name})`,t.querySelector(".player_disconnect .sub_message .value").innerText=avatar.room,init(void 0),1==e.id&&(P2.changeID(1),P1=P2,avatar=P1,currentPlayer=P1,P2=void 0),setTimeout(()=>{t.parentElement.classList.remove("unset_disconnect"),waitingUser(!0,!1,userMessages.opponentDisconnected)},5e3)}}function init(e){if(e)e.score=0,1==e.id?P1=e:2==e.id&&(P2=e),currentPlayer=P1,e.official&&1==e.id&&(turn=!0,document.querySelector(".code_display .value").innerText=e.room),e.official&&(1==e.id?avatar=P1:2==e.id&&(avatar=P2)),avatar&&(avatar.id==P1.id?P1=avatar:avatar.id==P2.id&&(P2=avatar),avatar.setDetails()),P1&&P2?(events(),setPuck(),resetCase(),avatar==currentPlayer?(waitingUser(!1,!0),turn=!0):waitingUser(),document.querySelector(".code_display")&&document.querySelector(".code_display").remove()):avatar&&(P1||P2)&&waitingUser(!0,!1,userMessages.opponentNeeded);else{let e=new Player(2,"","","",!1,"");e.setDetails()}}let caseColumns=Array.from(document.querySelectorAll(".case .columns")),previewColumns=Array.from(document.querySelectorAll(".preview .cell"));const userWait=document.querySelector(".user_wait"),resetColumns={case:caseColumns[0].parentElement.cloneNode(!0).innerHTML,preview:previewColumns[0].parentElement.cloneNode(!0).innerHTML},previewPuck=document.querySelector(".preview_puck"),defaultPuckTop=parseInt(getComputedStyle(previewPuck).top.slice(0,-2)),minStreak=4,columns=7,rows=6,userMessages={opponentsTurn:{title:"Waiting for Opponent",subTitle:"Opponent's turn to play"},opponentNeeded:{title:"Waiting for Opponent",subTitle:"At least two players needed"},opponentDisconnected:{title:"Waiting for Opponent",subTitle:"At least two players needed"}};let P1,P2,avatar,currentPlayer,interval,turn=!1,streaks=possibleWins();